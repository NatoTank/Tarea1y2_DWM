<!DOCTYPE html>
<html lang="es">
<head>
  <title>Chocomania - Registro</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="config.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    body {
      background-color: #f8f9fa;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    .choco-header {
      background-color: #7B3F00;
      color: white;
      padding: 15px 0;
      margin-bottom: 30px;
    }
    .choco-logo {
      font-weight: bold;
      font-size: 1.8rem;
    }
    .registration-card {
      max-width: 450px;
      margin: 0 auto;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      border-radius: 10px;
      border: none;
    }
    .card-header {
      background-color: #7B3F00;
      color: white;
      border-radius: 10px 10px 0 0 !important;
      text-align: center;
      padding: 15px;
      font-weight: bold;
    }
    .btn-choco {
      background-color: #7B3F00;
      color: white;
      width: 100%;
      padding: 10px;
    }
    .btn-choco:hover {
      background-color: #5a2e00;
      color: white;
    }
    .form-control:focus {
      border-color: #7B3F00;
      box-shadow: 0 0 0 0.25rem rgba(123, 63, 0, 0.25);
    }
    .alert-danger {
      display: none;
    }
    .password-info {
      font-size: 0.8rem;
      color: #6c757d;
    }
    .password-strength {
      height: 5px;
      margin-top: 5px;
      border-radius: 5px;
      transition: all 0.3s ease;
    }
    .strength-weak {
      background-color: #dc3545;
      width: 25%;
    }
    .strength-medium {
      background-color: #ffc107;
      width: 50%;
    }
    .strength-strong {
      background-color: #28a745;
      width: 100%;
    }
    /* ✅ AGREGAR ESTILOS PARA NOTIFICACIÓN DE ÉXITO */
    .success-notification {
        position: fixed;
        top: 20px;
        right: 20px;
        background: linear-gradient(135deg, #28a745, #20c997);
        color: white;
        padding: 20px 30px;
        border-radius: 10px;
        box-shadow: 0 5px 20px rgba(40, 167, 69, 0.4);
        z-index: 10000;
        display: none;
        animation: slideInRight 0.5s ease-out;
    }
    
    .success-notification.show {
        display: flex !important;
        align-items: center;
        gap: 15px;
    }
    
    .success-notification i {
        font-size: 2rem;
    }
    
    @keyframes slideInRight {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
    /* Estilos mejorados para el modal de éxito */
    .modal-success .modal-content {
      border: none;
      border-radius: 15px;
    }
    .modal-success .modal-header {
      background: linear-gradient(135deg, #28a745, #20c997);
      color: white;
      border-radius: 15px 15px 0 0;
      padding: 20px;
    }
    .modal-success .modal-body {
      padding: 30px;
      text-align: center;
    }
    .modal-success .success-icon {
      font-size: 4rem;
      color: #28a745;
      margin-bottom: 20px;
    }
    .modal-success .modal-title {
      font-weight: bold;
      font-size: 1.5rem;
    }
    /* Mensaje de éxito en la página */
    .success-message {
      display: none;
      background: linear-gradient(135deg, #28a745, #20c997);
      color: white;
      padding: 30px;
      border-radius: 15px;
      text-align: center;
      margin-bottom: 20px;
      animation: slideDown 0.5s ease-out;
      box-shadow: 0 5px 20px rgba(40, 167, 69, 0.3);
    }
    
    .success-message.show {
      display: block;
    }
    
    .success-message i {
      font-size: 4rem;
      margin-bottom: 15px;
      display: block;
    }
    
    .success-message h3 {
      margin-bottom: 10px;
      font-weight: bold;
    }
    
    .success-message p {
      margin: 5px 0;
      font-size: 1rem;
    }
    
    .success-message .btn {
      margin-top: 20px;
      background-color: white;
      color: #28a745;
      font-weight: bold;
      padding: 10px 30px;
      border: none;
    }
    
    .success-message .btn:hover {
      background-color: #f8f9fa;
      color: #20c997;
    }
    
    @keyframes slideDown {
      from {
        transform: translateY(-100%);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }
    
    .registration-card.hide {
      display: none;
    }
  </style>
</head>
<body>
    <!-- Notificación de éxito -->
    <div class="success-notification" id="successNotification">
        <i class="fas fa-check-circle"></i>
        <div>
            <strong>¡Cuenta creada exitosamente!</strong>
            <p style="margin: 0; font-size: 0.9rem;">Ya puedes iniciar sesión con tu email y contraseña.</p>
        </div>
    </div>

  <div class="container mt-3 mb-3">
        <div class="d-flex justify-content-between align-items-center">
            <a href="Home.html" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-2"></i>Volver al Inicio
            </a>
  </div>

  <div class="choco-header text-center">
    <div class="container">
      <div class="choco-logo">Chocomania</div>
      <div>https://www.Chocomania.cl</div>
    </div>
  </div>

  <div class="container">
    <div class="row justify-content-center">
      <div class="col-md-6">
        <!-- Mensaje de éxito -->
        <div class="success-message" id="successMessage">
          <i class="fas fa-check-circle"></i>
          <h3>¡Cuenta Creada Exitosamente!</h3>
          <p>Bienvenido a Chocomania</p>
          <p class="mt-2">Tu registro ha sido completado correctamente.</p>
          <p>Ahora puedes iniciar sesión y disfrutar de nuestros deliciosos productos.</p>
          <button class="btn" onclick="window.location.href='Ingreso.html'">
            <i class="fas fa-sign-in-alt me-2"></i>Ir a Iniciar Sesión
          </button>
        </div>

        <div class="card registration-card" id="registrationCard">
          <div class="card-header">
            REGISTRAR
          </div>
          <div class="card-body p-4">
            <form id="registrationForm">
              <div class="mb-3">
                <label for="email" class="form-label">USUARIO</label>
                <input type="email" class="form-control" id="email" placeholder="anag@example.com" required>
              </div>
              <div class="mb-3">
                <label for="password" class="form-label">CONTRASEÑA</label>
                <input type="password" class="form-control" id="password" placeholder="********" required>
                <div class="password-strength" id="passwordStrength"></div>
                <div class="password-info mt-1">
                  La contraseña debe tener al menos 8 caracteres, incluyendo una letra mayúscula y un número.
                </div>
              </div>
              <div class="mb-3">
                <label for="confirmPassword" class="form-label">CONFIRMAR CONTRASEÑA</label>
                <input type="password" class="form-control" id="confirmPassword" placeholder="********" required>
              </div>
              <div class="alert alert-danger mt-3" id="errorMessage" role="alert">
                El Email ya está en uso
              </div>
              <button type="submit" class="btn btn-choco mt-3">Registrar</button>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
      // Tu lógica de validación de contraseña (VISUAL) - Se mantiene
      document.getElementById('password').addEventListener('input', function() {
        const password = this.value;
        const strengthBar = document.getElementById('passwordStrength');
        strengthBar.className = 'password-strength';
        if (password.length === 0) return;
        
        let strength = 0;
        if (password.length >= 8) strength += 1;
        if (/[A-Z]/.test(password)) strength += 1;
        if (/\d/.test(password)) strength += 1;
        
        if (strength === 1) strengthBar.classList.add('strength-weak');
        else if (strength === 2) strengthBar.classList.add('strength-medium');
        else if (strength >= 3) strengthBar.classList.add('strength-strong');
      });

      // INTEGRACIÓN DE REGISTRO (B-01)
      document.getElementById('registrationForm').addEventListener('submit', async function(event) {
        event.preventDefault();
        
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const confirmPassword = document.getElementById('confirmPassword').value;
        const errorMessage = document.getElementById('errorMessage');
        
        errorMessage.style.display = 'none';
        
        if (password !== confirmPassword) {
          errorMessage.textContent = 'Las contraseñas no coinciden';
          errorMessage.style.display = 'block';
          return;
        }
        
        // Deshabilitar botón mientras se procesa
        const submitBtn = event.target.querySelector('button[type="submit"]');
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Registrando...';
        
        try {
          // Conexión real al endpoint /usuarios/registrar
          const response = await fetch(`${API_URL}/usuarios/registrar`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ email: email, contraseña: password })
          });

          if (response.ok) {
              // Ocultar el formulario y mostrar mensaje de éxito
              document.getElementById('registrationCard').classList.add('hide');
              document.getElementById('successMessage').classList.add('show');
              
              // Hacer scroll al mensaje de éxito
              document.getElementById('successMessage').scrollIntoView({ 
                behavior: 'smooth', 
                block: 'center' 
              });
              
              // Opcional: Redirigir automáticamente después de 5 segundos
              setTimeout(() => {
                window.location.href = 'Ingreso.html';
              }, 5000);
          } else {
              const error = await response.json();
              errorMessage.textContent = error.detail || 'Error al registrar. El correo podría estar en uso.';
              errorMessage.style.display = 'block';
          }
        } catch (error) {
          errorMessage.textContent = 'Error de conexión con el servidor';
          errorMessage.style.display = 'block';
        } finally {
          submitBtn.disabled = false;
          submitBtn.innerHTML = 'Registrar';
        }
      });

      // ✅ AGREGAR AL INICIO DEL SCRIPT (después de las variables globales)
      document.addEventListener('DOMContentLoaded', function() {
        // Verificar si viene desde un registro exitoso
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('registered') === 'true') {
            mostrarNotificacionExito();
            // Limpiar URL sin recargar la página
            window.history.replaceState({}, document.title, window.location.pathname);
        }
    });
    
    // ✅ FUNCIÓN PARA MOSTRAR NOTIFICACIÓN
    function mostrarNotificacionExito() {
        const notification = document.getElementById('successNotification');
        notification.classList.add('show');
        
        // Ocultar después de 5 segundos
        setTimeout(() => {
            notification.classList.remove('show');
        }, 5000);
    }

    // ✅ MODIFICAR LA FUNCIÓN registerUser PARA REDIRIGIR CON PARÁMETRO
    async function registerUser(event) {
        event.preventDefault();
        
        const email = document.getElementById('registerEmail').value;
        const password = document.getElementById('registerPassword').value;
        const confirmPassword = document.getElementById('registerConfirmPassword').value;
        
        // Validación
        if (password !== confirmPassword) {
            alert("Las contraseñas no coinciden");
            return;
        }
        
        if (password.length < 6) {
            alert("La contraseña debe tener al menos 6 caracteres");
            return;
        }

        const registerBtn = document.getElementById('registerBtn');
        registerBtn.disabled = true;
        registerBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Creando cuenta...';

        try {
            const response = await fetch(`${API_URL}/usuarios/registrar`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    email: email,
                    contraseña: password
                })
            });

            if (response.ok) {
                const data = await response.json();
                console.log("Usuario registrado:", data);
                
                // ✅ REDIRIGIR CON PARÁMETRO PARA MOSTRAR MENSAJE
                window.location.href = 'Login.html?registered=true';
            } else {
                const error = await response.json();
                alert("Error: " + (error.detail || "No se pudo registrar el usuario"));
            }
        } catch (error) {
            console.error("Error:", error);
            alert("Error de conexión: " + error.message);
        } finally {
            registerBtn.disabled = false;
            registerBtn.innerHTML = '<i class="fas fa-user-plus me-2"></i>Crear Cuenta';
        }
    }
  </script>
</body>
</html>