<!DOCTYPE html>
<html lang="es">
<head>
  <title>Chocomania - Cat√°logo con Filtros</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="config.js"></script>
  <style>
    body {
      background-color: #f8f9fa;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    .choco-header {
      background-color: #7B3F00;
      color: white;
      padding: 15px 0;
      margin-bottom: 30px;
    }
    .choco-logo {
      font-weight: bold;
      font-size: 1.8rem;
    }
    .product-card {
      border: none;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      transition: transform 0.3s, box-shadow 0.3s;
      margin-bottom: 25px;
      height: 100%;
      overflow: hidden;
    }
    .product-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 16px rgba(0,0,0,0.15);
    }
    .product-image-container {
      height: 250px;
      border-radius: 10px 10px 0 0;
      overflow: hidden;
      position: relative;
      background-color: #f5e6d3;
    }
    .product-image {
      width: 100%;
      height: 100%;
      object-fit: contain;
      transition: transform 0.3s ease;
      background-color: white;
    }
    .product-card:hover .product-image {
      transform: scale(1.05);
    }
    .product-title {
      color: #7B3F00;
      font-weight: bold;
      margin-bottom: 10px;
    }
    .product-price {
      font-weight: bold;
      color: #28a745;
      font-size: 1.2rem;
    }
    .product-category {
      font-size: 0.9rem;
      color: #6c757d;
      margin-bottom: 10px;
    }
    .pagination-container {
      margin-top: 30px;
    }
    .page-item.active .page-link {
      background-color: #7B3F00;
      border-color: #7B3F00;
    }
    .page-link {
      color: #7B3F00;
    }
    .empty-catalog {
      text-align: center;
      padding: 50px 20px;
      color: #6c757d;
    }
    .empty-catalog i {
      font-size: 4rem;
      margin-bottom: 20px;
      color: #dee2e6;
    }
    .filter-section {
      background-color: white;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 25px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    .catalog-title {
      color: #7B3F00;
      font-weight: bold;
      margin-bottom: 25px;
      text-align: center;
      border-bottom: 2px solid #7B3F00;
      padding-bottom: 10px;
    }
    .btn-choco {
      background-color: #7B3F00;
      color: white;
      border: none;
    }
    .btn-choco:hover {
      background-color: #5a2e00;
      color: white;
    }
    .artist-info {
      font-size: 0.8rem;
      color: #6c757d;
      text-align: center;
      margin-top: 30px;
      padding-top: 15px;
      border-top: 1px solid #dee2e6;
    }
    .card-body {
      padding: 20px;
    }
    .image-placeholder {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: #7B3F00;
      font-size: 3rem;
      background-color: #f5e6d3;
    }
    .product-image.loading {
      opacity: 0;
    }
    .product-image.loaded {
      opacity: 1;
      transition: opacity 0.3s ease;
    }
    .sidebar-filters {
      background: white;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      height: fit-content;
      position: sticky;
      top: 20px;
    }
    .filter-group {
      margin-bottom: 25px;
    }
    .filter-title {
      color: #7B3F00;
      font-weight: bold;
      margin-bottom: 15px;
      font-size: 1.1rem;
      border-bottom: 2px solid #f0f0f0;
      padding-bottom: 8px;
    }
    .form-check {
      margin-bottom: 10px;
      padding-left: 0;
    }
    .form-check-input:checked {
      background-color: #7B3F00;
      border-color: #7B3F00;
    }
    .form-check-label {
      cursor: pointer;
      padding-left: 30px;
      display: block;
    }
    .active-filters {
      background: #e9ecef;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
    }
    .filter-tag {
      display: inline-block;
      background: #7B3F00;
      color: white;
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 0.85rem;
      margin: 3px;
    }
    .filter-tag .remove {
      margin-left: 8px;
      cursor: pointer;
      font-weight: bold;
    }
    .clear-filters {
      color: #7B3F00;
      text-decoration: none;
      font-size: 0.9rem;
      cursor: pointer;
    }
    .clear-filters:hover {
      text-decoration: underline;
    }
    .results-count {
      color: #6c757d;
      font-size: 0.9rem;
      margin-bottom: 15px;
    }
    .cart-notification {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1050;
      background: #28a745;
      color: white;
      padding: 15px 20px;
      border-radius: 5px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      display: none;
      animation: slideIn 0.3s ease-out;
    }
    
    /* ‚úÖ AGREGAR ESTA CLASE QUE FALTABA */
    .cart-notification.show {
      display: block !important;
    }
    
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    
    /* ‚úÖ AGREGAR: Hacer sidebar responsive */
    @media (max-width: 991px) {
        .sidebar-filters {
            position: static;
            margin-bottom: 20px;
        }
        
        .filter-section {
            padding: 15px;
        }
        
        .product-card {
            margin-bottom: 15px;
        }
    }
    
    @media (max-width: 576px) {
        .choco-logo {
            font-size: 1.5rem;
        }
        
        .catalog-title {
            font-size: 1.5rem;
        }
        
        .product-image-container {
            height: 200px;
        }
        
        .product-title {
            font-size: 1rem;
        }
        
        .product-price {
            font-size: 1.1rem;
        }
        
        /* Botones m√°s peque√±os */
        .btn-choco {
            font-size: 0.9rem;
            padding: 10px;
        }
        
        /* Filtros en accordion para m√≥viles */
        .filter-group {
            margin-bottom: 15px;
        }
        
        .filter-title {
            font-size: 1rem;
        }
    }
  </style>
</head>
<body>
  <div class="choco-header text-center">
    <div class="container">
      <div class="choco-logo">Chocomania</div>
      <div>https://www.Chocomania.cl</div>
    </div>
  </div>

  <!-- Notificaci√≥n de carrito -->
  <div class="cart-notification" id="cartNotification">
    <i class="fas fa-check-circle me-2"></i>
    <span id="notificationMessage">Producto agregado al carrito</span>
  </div>

  <div class="container">
    <h1 class="catalog-title">CAT√ÅLOGO DE CHOCOLATES - FILTROS</h1>
    
    <!-- Barra de navegaci√≥n adicional -->
    <div class="d-flex justify-content-between align-items-center mb-4">
      <a href="home.html" class="btn btn-outline-secondary">
        <i class="fas fa-arrow-left me-2"></i>Volver al Inicio
      </a>
      <a href="ArmadoPedido.html" class="btn btn-choco position-relative">
        <i class="fas fa-shopping-cart me-2"></i>Ver Carrito
        <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" id="cartBadge">0</span>
      </a>
    </div>
    
    <div class="row">
      <!-- Sidebar de Filtros -->
      <div class="col-lg-3 col-md-4">
        <!-- ‚úÖ MODIFICAR: Agregar bot√≥n collapse para filtros en m√≥viles -->
        <div class="d-lg-none mb-3">
            <button class="btn btn-choco w-100" type="button" data-bs-toggle="collapse" data-bs-target="#mobileFilters">
                <i class="fas fa-filter me-2"></i>Mostrar Filtros
            </button>
        </div>
        
        <div class="sidebar-filters collapse d-lg-block" id="mobileFilters">
          <h5 class="filter-title">FILTROS POR TIPO</h5>
          
          <div class="filter-group">
            <h6 class="filter-title">Categor√≠as</h6>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="filter-bombones" value="Bombones">
              <label class="form-check-label" for="filter-bombones">
                Bombones
              </label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="filter-tabletas" value="Tabletas">
              <label class="form-check-label" for="filter-tabletas">
                Tabletas
              </label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="filter-alfajores" value="Alfajores">
              <label class="form-check-label" for="filter-alfajores">
                Alfajores
              </label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="filter-macaroons" value="Macaroons">
              <label class="form-check-label" for="filter-macaroons">
                Macaroons
              </label>
            </div>
          </div>

          <div class="filter-group">
            <h6 class="filter-title">Tipos de Bombones</h6>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="filter-bombones-surtidos" value="Bombones Surtidos">
              <label class="form-check-label" for="filter-bombones-surtidos">
                Bombones Surtidos
              </label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="filter-bombones-especiales" value="Bombones Especiales">
              <label class="form-check-label" for="filter-bombones-especiales">
                Bombones Especiales
              </label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="filter-bombones-licor" value="Bombones de Licor">
              <label class="form-check-label" for="filter-bombones-licor">
                Bombones de Licor
              </label>
            </div>
          </div>

          <div class="filter-group">
            <h6 class="filter-title">Precio</h6>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="filter-precio-1" value="precio-0-5000">
              <label class="form-check-label" for="filter-precio-1">
                $0 - $5.000
              </label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="filter-precio-2" value="precio-5000-10000">
              <label class="form-check-label" for="filter-precio-2">
                $5.000 - $10.000
              </label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="filter-precio-3" value="precio-10000-15000">
              <label class="form-check-label" for="filter-precio-3">
                $10.000 - $15.000
              </label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="filter-precio-4" value="precio-15000+">
              <label class="form-check-label" for="filter-precio-4">
                $15.000+
              </label>
            </div>
          </div>

          <button class="btn btn-choco w-100 mb-2" id="applyFilters">
            <i class="fas fa-filter"></i> Aplicar Filtros
          </button>
          <button class="btn btn-outline-secondary w-100" id="clearFilters">
            <i class="fas fa-times"></i> Limpiar Filtros
          </button>
        </div>
      </div>

      <!-- Contenido Principal -->
      <div class="col-lg-9 col-md-8">
        <!-- Filtros Activos -->
        <div class="active-filters" id="activeFilters" style="display: none;">
          <div>
            <strong>FILTROS APLICADOS:</strong>
            <span id="activeFiltersList"></span>
          </div>
        </div>

        <!-- Contador de resultados -->
        <div class="results-count" id="resultsCount"></div>
        
        <!-- Cat√°logo de productos -->
        <div id="productsCatalog">
          <div class="row" id="productsContainer">
            <!-- Los productos se cargar√°n aqu√≠ din√°micamente -->
          </div>
          
          <!-- Paginaci√≥n -->
          <div class="row pagination-container">
            <div class="col-12 d-flex justify-content-center">
              <nav>
                <ul class="pagination" id="pagination">
                  <!-- La paginaci√≥n se generar√° din√°micamente -->
                </ul>
              </nav>
            </div>
          </div>
        </div>
        
        <!-- Mensaje cuando no hay productos -->
        <div id="emptyCatalog" class="empty-catalog" style="display: none;">
          <i class="fas fa-box-open"></i>
          <h3>No hay productos disponibles</h3>
          <p>Lo sentimos, no encontramos productos que coincidan con tus filtros.</p>
          <button class="btn btn-choco mt-3" id="resetFilters">
            <i class="fas fa-redo"></i> Reiniciar Filtros
          </button>
        </div>
      </div>
    </div>
    
    <!-- Informaci√≥n del artista -->
    <div class="artist-info">
      <p><strong>Artista:</strong> APPC:delogo</p>
      <p>c√≥nsar@mocconanilla.com.br, tama√±o: 1.0x10000%</p>
    </div>
  </div>

  <script>
    // Variables globales
    let allProducts = [];
    let filteredProducts = [];

    // ‚úÖ FUNCI√ìN PARA OBTENER IMAGEN ESPEC√çFICA POR NOMBRE DE PRODUCTO
    function getProductImage(nombre) {
      const nombreLower = nombre.toLowerCase();
      
      // Mapeo exacto nombre ‚Üí imagen
      if (nombreLower.includes('chocolate avenida')) return 'ChocolateAvenida.png';
      if (nombreLower.includes('chocolate con leche')) return 'ChocolateLeche.png';
      if (nombreLower.includes('chocolate blanco') && !nombreLower.includes('bombones')) return 'ChocolateBlanco.png';
      if (nombreLower.includes('chocolate con almendras')) return 'ChocolateAlmendras.png';
      if (nombreLower.includes('bombones chocolate negro')) return 'Bombones.png';
      if (nombreLower.includes('bombones chocolate blanco')) return 'BombonesBlanco.png';
      if (nombreLower.includes('alfajor')) return 'Alfajores.png';
      if (nombreLower.includes('macaroon')) return 'Macaroons.png';
      
      // Por defecto
      return 'ChocolateLeche.png';
    }

    // ‚úÖ CARGAR PRODUCTOS (MISMA API)
    async function loadProductsFromAPI() {
      try {
        console.log("üîç Cargando productos desde /productos/...");
        console.log("API_URL:", API_URL);
        
        const response = await fetch(`${API_URL}/productos/`);
        
        console.log("Response status:", response.status);
        
        if (response.ok) {
          allProducts = await response.json();
          console.log("‚úÖ Productos cargados:", allProducts.length, allProducts);
          
          filteredProducts = [...allProducts];
          renderProducts();
          updateResultsCount();
        } else {
          console.error("Error:", response.status);
          document.getElementById('resultsCount').textContent = 'Error al cargar';
          document.getElementById('emptyCatalog').style.display = 'block';
          document.getElementById('productsCatalog').style.display = 'none';
        }
      } catch (error) {
        console.error("Error de conexi√≥n:", error);
        document.getElementById('resultsCount').textContent = 'Error de conexi√≥n: ' + error.message;
        document.getElementById('emptyCatalog').style.display = 'block';
        document.getElementById('productsCatalog').style.display = 'none';
      }
    }

    // ‚úÖ CORREGIR FUNCI√ìN DE FILTROS
    function applyFilters() {
      console.log("üîç Aplicando filtros...");
      
      // Obtener categor√≠as principales seleccionadas (Bombones, Tabletas, Alfajores, Macaroons)
      const selectedCategories = [];
      if (document.getElementById('filter-bombones').checked) selectedCategories.push('Bombones');
      if (document.getElementById('filter-tabletas').checked) selectedCategories.push('Tabletas');
      if (document.getElementById('filter-alfajores').checked) selectedCategories.push('Alfajores');
      if (document.getElementById('filter-macaroons').checked) selectedCategories.push('Macaroons');
      
      // Obtener subcategor√≠as de bombones
      const selectedBombonesTypes = [];
      if (document.getElementById('filter-bombones-surtidos').checked) selectedBombonesTypes.push('Bombones Surtidos');
      if (document.getElementById('filter-bombones-especiales').checked) selectedBombonesTypes.push('Bombones Especiales');
      if (document.getElementById('filter-bombones-licor').checked) selectedBombonesTypes.push('Bombones de Licor');
      
      // Obtener rangos de precio seleccionados
      const selectedPrices = [];
      if (document.getElementById('filter-precio-1').checked) selectedPrices.push('precio-0-5000');
      if (document.getElementById('filter-precio-2').checked) selectedPrices.push('precio-5000-10000');
      if (document.getElementById('filter-precio-3').checked) selectedPrices.push('precio-10000-15000');
      if (document.getElementById('filter-precio-4').checked) selectedPrices.push('precio-15000+');
      
      console.log("Categor√≠as seleccionadas:", selectedCategories);
      console.log("Tipos de bombones:", selectedBombonesTypes);
      console.log("Rangos de precio:", selectedPrices);
      
      filteredProducts = allProducts.filter(product => {
        // ‚úÖ FILTRO DE CATEGOR√çA PRINCIPAL
        let matchesCategory = true;
        if (selectedCategories.length > 0) {
          // Verificar si el tipo del producto coincide EXACTAMENTE con alguna categor√≠a seleccionada
          matchesCategory = selectedCategories.some(cat => {
            const productType = product.tipo.toLowerCase();
            const category = cat.toLowerCase();
            
            // Si es Bombones, verificar subcategor√≠as si hay seleccionadas
            if (category === 'bombones') {
              if (selectedBombonesTypes.length > 0) {
                return selectedBombonesTypes.some(subType => 
                  productType.includes(subType.toLowerCase())
                );
              }
              // Si no hay subcategor√≠as, aceptar cualquier bomb√≥n
              return productType.includes('bombon');
            }
            
            // Para Tabletas, Alfajores, Macaroons: coincidencia exacta
            return productType.includes(category);
          });
        }
        
        // ‚úÖ FILTRO DE PRECIO
        let matchesPrice = true;
        if (selectedPrices.length > 0) {
          matchesPrice = selectedPrices.some(priceRange => {
            const precio = product.precio;
            
            if (priceRange === 'precio-0-5000') {
              return precio >= 0 && precio <= 5000;
            } else if (priceRange === 'precio-5000-10000') {
              return precio > 5000 && precio <= 10000;
            } else if (priceRange === 'precio-10000-15000') {
              return precio > 10000 && precio <= 15000;
            } else if (priceRange === 'precio-15000+') {
              return precio > 15000;
            }
            return false;
          });
        }
        
        // Debe cumplir AMBOS filtros (categor√≠a Y precio)
        return matchesCategory && matchesPrice;
      });
      
      console.log(`‚úÖ ${filteredProducts.length} productos despu√©s de filtros`, filteredProducts);
      
      renderProducts();
      updateResultsCount();
      updateActiveFilters(selectedCategories, selectedBombonesTypes, selectedPrices);
    }

    // ‚úÖ AGREGAR FUNCI√ìN PARA MOSTRAR FILTROS ACTIVOS
    function updateActiveFilters(categories, bombonesTypes, prices) {
      const activeFiltersDiv = document.getElementById('activeFilters');
      const filtersList = document.getElementById('activeFiltersList');
      
      const allFilters = [...categories, ...bombonesTypes];
      
      // Agregar etiquetas de precio
      prices.forEach(p => {
        if (p === 'precio-0-5000') allFilters.push('$0 - $5.000');
        else if (p === 'precio-5000-10000') allFilters.push('$5.000 - $10.000');
        else if (p === 'precio-10000-15000') allFilters.push('$10.000 - $15.000');
        else if (p === 'precio-15000+') allFilters.push('$15.000+');
      });
      
      if (allFilters.length > 0) {
        activeFiltersDiv.style.display = 'block';
        filtersList.innerHTML = allFilters.map(f => 
          `<span class="filter-tag">${f} <span class="remove" onclick="removeFilter('${f}')">√ó</span></span>`
        ).join('');
      } else {
        activeFiltersDiv.style.display = 'none';
      }
    }

    function renderProducts() {
      const container = document.getElementById('productsContainer');
      const emptyCatalog = document.getElementById('emptyCatalog');
      const productsCatalog = document.getElementById('productsCatalog');
      
      container.innerHTML = '';
      
      if (filteredProducts.length === 0) {
        productsCatalog.style.display = 'none';
        emptyCatalog.style.display = 'block';
        return;
      }
      
      productsCatalog.style.display = 'block';
      emptyCatalog.style.display = 'none';
      
      filteredProducts.forEach(product => {
        const col = document.createElement('div');
        col.className = 'col-md-4 col-sm-6 mb-4';
        const imagenProducto = getProductImage(product.nombre); // ‚úÖ Usar nombre, no tipo
        
        col.innerHTML = `
          <div class="card product-card">
            <div class="product-image-container">
              <img class="product-image" src="${imagenProducto}" alt="${product.nombre}">
            </div>
            <div class="card-body">
              <h5 class="product-title">${product.nombre}</h5>
              <div class="product-category">${product.tipo}</div>
              <div class="product-price">$${product.precio.toLocaleString('es-CL')}</div>
              <p class="text-muted">${product.descripcion || 'Delicioso chocolate'}</p>
              <button class="btn btn-choco mt-2 w-100" onclick="addToCart(${product.id}, '${product.nombre}', ${product.precio})">
                <i class="fas fa-shopping-cart"></i> Agregar al carrito
              </button>
            </div>
          </div>
        `;
        container.appendChild(col);
      });
    }

    function updateResultsCount() {
      const count = filteredProducts.length;
      const total = allProducts.length;
      document.getElementById('resultsCount').textContent = `${count} producto(s) de ${total}`;
    }

    function clearAllFilters() {
      document.querySelectorAll('.form-check-input:checked').forEach(cb => cb.checked = false);
      filteredProducts = [...allProducts];
      renderProducts();
      updateResultsCount();
      
      // ‚úÖ OCULTAR LA BARRA DE FILTROS ACTIVOS
      document.getElementById('activeFilters').style.display = 'none';
      document.getElementById('activeFiltersList').innerHTML = '';
    }

    function addToCart(productId, name, price) {
      const cart = JSON.parse(localStorage.getItem('chocomaniaCart')) || [];
      const existingProduct = cart.find(item => item.id == productId);
      
      if (existingProduct) {
        existingProduct.quantity += 1;
      } else {
        cart.push({ 
          id: productId, 
          name: name, 
          price: price, 
          image: getProductImage(name),
          quantity: 1 
        });
      }
      
      localStorage.setItem('chocomaniaCart', JSON.stringify(cart));
      
      // ‚úÖ CAMBIO: Usar notificaci√≥n visual en lugar de alert
      showNotification(`‚úÖ ${name} agregado al carrito`);
      
      updateCartBadge();
    }

    // ‚úÖ AGREGAR: Funci√≥n para mostrar notificaci√≥n (igual que Catalogo.html)
    function showNotification(message, type = 'success') {
      const notification = document.getElementById('cartNotification');
      const messageElement = document.getElementById('notificationMessage');
      
      messageElement.textContent = message;
      
      // Cambiar color seg√∫n tipo
      if (type === 'error') {
        notification.style.background = '#dc3545';
      } else {
        notification.style.background = '#28a745';
      }
      
      notification.classList.add('show');
      
      setTimeout(() => {
        notification.classList.remove('show');
        notification.style.background = '#28a745'; // Reset color
      }, 3000);
    }

    function updateCartBadge() {
      const cart = JSON.parse(localStorage.getItem('chocomaniaCart')) || [];
      const totalItems = cart.reduce((total, item) => total + item.quantity, 0);
      const badge = document.getElementById('cartBadge');
      if (badge) badge.textContent = totalItems;
    }

    // Inicializar
    document.addEventListener('DOMContentLoaded', async () => {
      await loadProductsFromAPI();
      updateCartBadge();
      
      document.getElementById('applyFilters').addEventListener('click', applyFilters);
      document.getElementById('clearFilters').addEventListener('click', clearAllFilters);
      document.getElementById('resetFilters').addEventListener('click', clearAllFilters);
    });
  </script>
</body>
</html>