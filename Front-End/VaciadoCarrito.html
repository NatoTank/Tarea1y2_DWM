<!DOCTYPE html>
<html lang="es">
<head>
    <title>Chocomanía - Vaciado del Carrito</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .choco-header {
            background-color: #7B3F00;
            color: white;
            padding: 15px 0;
            margin-bottom: 30px;
        }
        .choco-logo {
            font-weight: bold;
            font-size: 1.8rem;
        }
        .section-title {
            color: #7B3F00;
            font-weight: bold;
            margin-bottom: 25px;
            text-align: center;
            border-bottom: 2px solid #7B3F00;
            padding-bottom: 10px;
        }
        .cart-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            overflow: hidden;
        }
        .cart-header {
            background: linear-gradient(135deg, #7B3F00, #A0522D);
            color: white;
            padding: 20px;
        }
        .cart-body {
            padding: 30px;
        }
        .btn-choco {
            background-color: #7B3F00;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        .btn-choco:hover {
            background-color: #5a2e00;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(123, 63, 0, 0.3);
        }
        .btn-outline-choco {
            background-color: transparent;
            color: #7B3F00;
            border: 2px solid #7B3F00;
            padding: 12px 30px;
            border-radius: 25px;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        .btn-outline-choco:hover {
            background-color: #7B3F00;
            color: white;
        }
        .btn-danger-small {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .btn-danger-small:hover {
            background-color: #c82333;
            transform: translateY(-1px);
        }
        .table-choco {
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        .table-choco thead {
            background: linear-gradient(135deg, #7B3F00, #A0522D);
            color: white;
        }
        .total-box {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 10px;
            padding: 15px;
            color: #155724;
        }
        .artist-info {
            font-size: 0.8rem;
            color: #6c757d;
            text-align: center;
            margin-top: 30px;
            padding-top: 15px;
            border-top: 1px solid #dee2e6;
        }
        .empty-cart-message {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }
        .modal-choco .modal-header {
            background: linear-gradient(135deg, #7B3F00, #A0522D);
            color: white;
        }
    </style>
</head>
<body>

    <!-- Header -->
    <div class="choco-header text-center">
        <div class="container">
            <div class="choco-logo">Chocomanía</div>
            <div>https://www.Chocomania.cl</div>
        </div>
    </div>

    <div class="container mt-3">
        <a href="Home.html" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-2"></i>Volver al Inicio
        </a>
    </div>
    
    <div class="container">
        <h1 class="section-title">VACIADO DEL CARRITO</h1>
        
        <!-- Tarjeta del Carrito -->
        <div class="row justify-content-center">
            <div class="col-12 col-lg-10">
                <div class="cart-card">
                    <div class="cart-header text-center">
                        <h3><i class="fas fa-shopping-cart me-2"></i>Productos en el Carrito</h3>
                        <p class="mb-0">Revisa y gestiona tus productos antes de vaciar</p>
                    </div>
                    
                    <div class="cart-body">
                        <!-- Tabla de Productos -->
                        <div class="table-responsive" id="cartTableContainer">
                            <table class="table table-choco">
                                <thead>
                                    <tr>
                                        <th>Producto</th>
                                        <th class="text-center">Cantidad</th>
                                        <th class="text-end">Precio</th>
                                        <th class="text-end">Subtotal</th>
                                        <th class="text-center">Acción</th>
                                    </tr>
                                </thead>
                                <tbody id="cartItems">
                                    <!-- Los productos se cargarán aquí -->
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Mensaje de carrito vacío -->
                        <div class="empty-cart-message d-none" id="emptyCartMessage">
                            <i class="fas fa-shopping-cart fa-3x mb-3"></i>
                            <h4>Tu carrito está vacío</h4>
                            <p>No has agregado ningún producto a tu carrito.</p>
                            <button class="btn btn-choco mt-3" onclick="continueShopping()">
                                <i class="fas fa-store me-2"></i>Seguir Comprando
                            </button>
                        </div>
                        
                        <!-- Total -->
                        <div class="row mt-4" id="totalSection">
                            <div class="col-12">
                                <div class="d-flex justify-content-end">
                                    <div class="total-box">
                                        <h4 class="mb-0">TOTAL: $<span id="cartTotal">0</span></h4>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Botones de Acción -->
                        <div class="d-flex flex-wrap gap-3 justify-content-between mt-4" id="actionButtons">
                            <button class="btn btn-outline-choco" onclick="continueShopping()">
                                <i class="fas fa-arrow-left me-2"></i>Seguir Comprando
                            </button>
                            <div class="d-flex gap-3">
                                <button class="btn btn-outline-choco" onclick="showClearCartModal()">
                                    <i class="fas fa-trash me-2"></i>Vaciar Carrito
                                </button>
                                <button class="btn btn-choco" onclick="confirmOrder()">
                                    <i class="fas fa-check me-2"></i>Confirmar Pedido
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Información del artista -->
        <div class="artist-info">
            <p><strong>Artista:</strong> APPC:delogo</p>
            <p>consar@mocconanilla.com.br, tamaño: 1.0x10000%</p>
        </div>
    </div>

    <!-- Modal de Confirmación de Vaciado -->
    <div class="modal fade" id="clearCartModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content modal-choco">
                <div class="modal-header">
                    <h5 class="modal-title">Confirmar Vaciado del Carrito</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>¿Estás seguro de que quieres vaciar todo el carrito?</p>
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Esta acción no se puede deshacer.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-choco" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-choco" onclick="clearCart()">Sí, Vaciar Carrito</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Función para obtener el carrito desde localStorage
        function getCart() {
            const cart = localStorage.getItem('chocomaniaCart');
            return cart ? JSON.parse(cart) : [];
        }

        // Función para guardar el carrito en localStorage
        function saveCart(cart) {
            localStorage.setItem('chocomaniaCart', JSON.stringify(cart));
        }

        // Función para formatear precios
        function formatPrice(price) {
            return price.toLocaleString('es-CL');
        }

        // Función para calcular el total del carrito
        function calculateCartTotal() {
            const cart = getCart();
            return cart.reduce((total, item) => total + (item.price * item.quantity), 0);
        }

        // Función para renderizar los productos del carrito
        function renderCartItems() {
            const cartItemsContainer = document.getElementById('cartItems');
            const cart = getCart();
            
            cartItemsContainer.innerHTML = '';
            
            cart.forEach(item => {
                const subtotal = item.price * item.quantity;
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <strong>${item.name}</strong>
                        <div class="text-muted small">Código: ${item.id}</div>
                    </td>
                    <td class="text-center">
                        <div class="d-flex align-items-center justify-content-center">
                            <button class="btn btn-sm btn-outline-secondary me-2" onclick="decreaseQuantity(${item.id})">-</button>
                            <span class="mx-2">${item.quantity}</span>
                            <button class="btn btn-sm btn-outline-secondary ms-2" onclick="increaseQuantity(${item.id})">+</button>
                        </div>
                    </td>
                    <td class="text-end">$${formatPrice(item.price)}</td>
                    <td class="text-end">$${formatPrice(subtotal)}</td>
                    <td class="text-center">
                        <button class="btn btn-danger-small" onclick="removeItem(${item.id})">
                            <i class="fas fa-trash"></i> Eliminar
                        </button>
                    </td>
                `;
                cartItemsContainer.appendChild(row);
            });
            
            // Actualizar el total
            const total = calculateCartTotal();
            document.getElementById('cartTotal').textContent = formatPrice(total);
        }

        // Función para actualizar la vista del carrito
        function updateCartView() {
            const cartTableContainer = document.getElementById('cartTableContainer');
            const totalSection = document.getElementById('totalSection');
            const actionButtons = document.getElementById('actionButtons');
            const emptyCartMessage = document.getElementById('emptyCartMessage');
            const cart = getCart();
            
            // Si el carrito está vacío
            if (cart.length === 0) {
                cartTableContainer.classList.add('d-none');
                totalSection.classList.add('d-none');
                actionButtons.classList.add('d-none');
                emptyCartMessage.classList.remove('d-none');
                return;
            }
            
            // Mostrar elementos del carrito
            cartTableContainer.classList.remove('d-none');
            totalSection.classList.remove('d-none');
            actionButtons.classList.remove('d-none');
            emptyCartMessage.classList.add('d-none');
            
            renderCartItems();
        }

        // Funciones para manejar cantidades
        function increaseQuantity(itemId) {
            const cart = getCart();
            const item = cart.find(item => item.id === itemId);
            if (item) {
                item.quantity++;
                saveCart(cart);
                updateCartView();
            }
        }

        function decreaseQuantity(itemId) {
            const cart = getCart();
            const item = cart.find(item => item.id === itemId);
            if (item && item.quantity > 1) {
                item.quantity--;
                saveCart(cart);
                updateCartView();
            }
        }

        // Función para eliminar producto individual (Escenario Gherkin: Eliminación individual)
        function removeItem(itemId) {
            const cart = getCart();
            const newCart = cart.filter(item => item.id !== itemId);
            saveCart(newCart);
            updateCartView();
            alert('Producto eliminado del carrito.');
        }

        // Función para mostrar modal de vaciado
        function showClearCartModal() {
            const cart = getCart();
            if (cart.length === 0) {
                alert('El carrito ya está vacío.');
                return;
            }
            const modal = new bootstrap.Modal(document.getElementById('clearCartModal'));
            modal.show();
        }

        // ✅ CORREGIR: Función para vaciar carrito (SOLO LOCAL, SIN BACKEND)
        function clearCart() {
            // 1. Vaciar localStorage
            localStorage.removeItem('chocomaniaCart');
            
            // 2. Cerrar modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('clearCartModal'));
            if (modal) modal.hide();
            
            // 3. Actualizar vista
            updateCartView();
            
            // 4. Mensaje de éxito
            alert('✅ El carrito ha sido vaciado completamente.');
            
            // 5. Redirigir a Home después de 1 segundo
            setTimeout(() => {
                window.location.href = 'Home.html';
            }, 1000);
        }

        // ✅ CORREGIR: Botón "Confirmar Pedido" vuelve a ArmadoPedido
        function confirmOrder() {
            const cart = getCart();
            if (cart.length === 0) {
                alert('El carrito está vacío.');
                return;
            }
            
            // Volver a ArmadoPedido sin vaciar
            window.location.href = 'ArmadoPedido.html';
        }

        // Inicializar la vista del carrito
        updateCartView();
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="config.js"></script>
    <script>
        // ✅ MODIFICAR: Función para vaciar carrito (SIN REDIRIGIR)
        async function clearCart() {
            // 1. Limpiar localStorage primero
            localStorage.removeItem('chocomaniaCart');
            
            // 2. Si está logueado, también vaciar en backend
            const token = localStorage.getItem('token');
            if (token) {
                try {
                    const response = await fetch(`${API_URL}/carrito`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (response.ok) {
                        console.log("✅ Carrito vaciado en backend también");
                    } else {
                        console.warn("⚠️ No se pudo vaciar backend, pero local sí");
                    }
                } catch (error) {
                    console.error("Error vaciando backend:", error);
                }
            }
            
            // 3. Cerrar modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('clearCartModal'));
            if (modal) modal.hide();
            
            // 4. Actualizar vista (mostrar carrito vacío)
            updateCartView();
            
            // 5. Mensaje de éxito (SIN TIMEOUT, SIN REDIRIGIR)
            alert('✅ El carrito ha sido vaciado completamente.');
        }
    </script>
</body>
</html>