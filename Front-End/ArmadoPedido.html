<!DOCTYPE html>
<html lang="es">
<head>
    <title>Chocomanía - Carrito de Compras</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="config.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .choco-header {
            background-color: #7B3F00;
            color: white;
            padding: 15px 0;
            margin-bottom: 30px;
        }
        .choco-logo {
            font-weight: bold;
            font-size: 1.8rem;
        }
        .section-title {
            color: #7B3F00;
            font-weight: bold;
            margin-bottom: 25px;
            text-align: center;
            border-bottom: 2px solid #7B3F00;
            padding-bottom: 10px;
        }
        .cart-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            overflow: hidden;
        }
        .cart-header {
            background: linear-gradient(135deg, #7B3F00, #A0522D);
            color: white;
            padding: 20px;
        }
        .cart-body {
            padding: 30px;
        }
        .btn-choco {
            background-color: #7B3F00;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        .btn-choco:hover {
            background-color: #5a2e00;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(123, 63, 0, 0.3);
        }
        .btn-outline-choco {
            background-color: transparent;
            color: #7B3F00;
            border: 2px solid #7B3F00;
            padding: 12px 30px;
            border-radius: 25px;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        .btn-outline-choco:hover {
            background-color: #7B3F00;
            color: white;
        }
        .table-choco {
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        .table-choco thead {
            background: linear-gradient(135deg, #7B3F00, #A0522D);
            color: white;
        }
        .table-choco tbody tr:hover {
            background-color: rgba(123, 63, 0, 0.05);
        }
        .total-box {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 10px;
            padding: 15px;
            color: #155724;
        }
        .artist-info {
            font-size: 0.8rem;
            color: #6c757d;
            text-align: center;
            margin-top: 30px;
            padding-top: 15px;
            border-top: 1px solid #dee2e6;
        }
        .customer-info {
            background-color: #e9ecef;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .order-confirmation {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 10px;
            padding: 20px;
            margin-top: 30px;
        }
        .empty-cart-message {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }
        .quantity-control {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .quantity-btn {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: #7B3F00;
            color: white;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        .quantity-input {
            width: 50px;
            text-align: center;
            margin: 0 10px;
            border: 1px solid #ced4da;
            border-radius: 5px;
            padding: 5px;
        }
        .remove-btn {
            color: #dc3545;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.2rem;
        }
        .remove-btn:hover {
            color: #bd2130;
        }
    </style>
<body>
    <!-- Header -->
    <div class="choco-header text-center">
        <div class="container">
            <div class="choco-logo">Chocomanía</div>
            <div>https://www.Chocomania.cl</div>
        </div>
    </div>

    <div class="container">
        <h1 class="section-title">MI CARRITO DE COMPRAS</h1>
        
        <!-- Información del Cliente -->
        <div class="row justify-content-center mb-4">
            <div class="col-12 col-md-8">
                <div class="customer-info">
                    <h5><i class="fas fa-user me-2"></i>Cliente: <span id="clienteNombre">Cargando...</span></h5>
                </div>
            </div>
        </div>
        
        <!-- Tarjeta del Carrito -->
        <div class="row justify-content-center">
            <div class="col-12 col-lg-10">
                <div class="cart-card">
                    <div class="cart-header text-center">
                        <h3><i class="fas fa-shopping-cart me-2"></i>Productos en el Carrito</h3>
                        <p class="mb-0">Revisa y confirma tu pedido</p>
                    </div>
                    
                    <div class="cart-body">
                        <!-- Tabla de Productos -->
                        <div class="table-responsive" id="cartTableContainer">
                            <table class="table table-choco" id="cartTable">
                                <thead>
                                    <tr>
                                        <th>Producto</th>
                                        <th class="text-center">Cantidad</th>
                                        <th class="text-end">Precio Unitario</th>
                                        <th class="text-end">Subtotal</th>
                                        <th class="text-center">Eliminar</th>
                                    </tr>
                                </thead>
                                <tbody id="cartItems">
                                    <!-- Los productos se cargarán dinámicamente aquí -->
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Mensaje de carrito vacío -->
                        <div class="empty-cart-message d-none" id="emptyCartMessage">
                            <i class="fas fa-shopping-cart fa-3x mb-3"></i>
                            <h4>Tu carrito está vacío</h4>
                            <p>No has agregado ningún producto a tu carrito.</p>
                            <button class="btn btn-choco mt-3" id="continueShoppingBtn">
                                <i class="fas fa-store me-2"></i>Continuar Comprando
                            </button>
                        </div>
                        
                        <!-- Total -->
                        <div class="row mt-4" id="totalSection">
                            <div class="col-12">
                                <div class="d-flex justify-content-end">
                                    <div class="total-box">
                                        <h4 class="mb-0">TOTAL: $<span id="cartTotal">0</span></h4>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Botones de Acción -->
                        <div class="d-flex flex-wrap gap-3 justify-content-between mt-4" id="actionButtons">
                            <button class="btn btn-outline-choco" id="continueShoppingBtn2">
                                <i class="fas fa-arrow-left me-2"></i>Seguir Comprando
                            </button>
                            <div class="d-flex gap-3">
                                <button class="btn btn-outline-choco" id="clearCartBtn">
                                    <i class="fas fa-trash me-2"></i>Vaciar Carrito
                                </button>
                                <button class="btn btn-choco" id="confirmOrderBtn">
                                    <i class="fas fa-check me-2"></i>Confirmar Pedido
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Información del artista -->
        <div class="artist-info">
            <p><strong>Artista:</strong> APPC:delogo</p>
            <p>cónsar@mocconanilla.com.br, tamaño: 1.0x10000%</p>
        </div>
    </div>

    <script src="config.js"></script>
    <script>
        // Referencias DOM
        const cartItemsContainer = document.getElementById('cartItems');
        const cartTableContainer = document.getElementById('cartTableContainer');
        const totalSection = document.getElementById('totalSection');
        const actionButtons = document.getElementById('actionButtons');
        const emptyCartMessage = document.getElementById('emptyCartMessage');
        const cartTotalElement = document.getElementById('cartTotal');
        const clienteNombreLabel = document.getElementById('clienteNombre'); // Referencia al nombre

        // --- 1. CARGAR DATOS DEL USUARIO (NUEVO) ---
        async function loadUserData() {
            const token = localStorage.getItem('token');
            if (!token) {
                if(clienteNombreLabel) clienteNombreLabel.textContent = "Invitado";
                return;
            }

            try {
                const response = await fetch(`${API_URL}/usuarios/me`, {
                    headers: getAuthHeaders()
                });
                if (response.ok) {
                    const user = await response.json();
                    // Si tiene nombre lo muestra, si no, muestra el email
                    if(clienteNombreLabel) {
                        clienteNombreLabel.textContent = user.nombre || user.email;
                    }
                }
            } catch (error) {
                console.error("Error cargando usuario", error);
            }
        }

        // --- 2. FUNCIONES DEL CARRITO ---
        function getLocalCart() { return JSON.parse(localStorage.getItem('chocomaniaCart')) || []; }
        function saveLocalCart(cart) { localStorage.setItem('chocomaniaCart', JSON.stringify(cart)); }
        function formatPrice(price) { return new Intl.NumberFormat('es-CL', { style: 'currency', currency: 'CLP' }).format(price); }

        function renderCart() {
            const cart = getLocalCart();
            cartItemsContainer.innerHTML = '';

            if (cart.length === 0) {
                cartTableContainer.classList.add('d-none');
                totalSection.classList.add('d-none');
                actionButtons.classList.add('d-none');
                emptyCartMessage.classList.remove('d-none');
                return;
            }

            cartTableContainer.classList.remove('d-none');
            totalSection.classList.remove('d-none');
            actionButtons.classList.remove('d-none');
            emptyCartMessage.classList.add('d-none');

            let total = 0;
            cart.forEach((item, index) => {
                const subtotal = item.price * item.quantity;
                total += subtotal;
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${item.name}</strong><div class="text-muted small">Código: ${item.id}</div></td>
                    <td class="text-center">
                        <button class="btn btn-sm btn-outline-secondary me-2" onclick="updateQty(${index}, -1)">-</button>
                        <span style="min-width:20px; display:inline-block;">${item.quantity}</span>
                        <button class="btn btn-sm btn-outline-secondary ms-2" onclick="updateQty(${index}, 1)">+</button>
                    </td>
                    <td class="text-end">${formatPrice(item.price)}</td>
                    <td class="text-end">${formatPrice(subtotal)}</td>
                    <td class="text-center">
                        <button class="btn btn-danger btn-sm" onclick="removeItem(${index})"><i class="fas fa-trash"></i></button>
                    </td>
                `;
                cartItemsContainer.appendChild(row);
            });
            cartTotalElement.textContent = formatPrice(total);
        }

        window.removeItem = function(index) {
            const cart = getLocalCart();
            cart.splice(index, 1);
            saveLocalCart(cart);
            renderCart();
        };

        window.updateQty = function(index, delta) {
            const cart = getLocalCart();
            const newQty = cart[index].quantity + delta;
            if (newQty > 0) {
                cart[index].quantity = newQty;
                saveLocalCart(cart);
                renderCart();
            }
        };

        // --- 3. CONFIRMAR PEDIDO (CORREGIDO) ---
        document.getElementById('confirmOrderBtn').onclick = async function() {
            const token = localStorage.getItem('token');
            if (!token) { 
                alert("Debes iniciar sesión"); 
                window.location.href = "Inicio.html"; 
                return; 
            }

            const cart = getLocalCart();
            if(cart.length === 0) {
                alert("El carrito está vacío");
                return;
            }

            // ✅ PASO 1: Guardar datos para ConfirmacionPedido.html
            const total = cart.reduce((acc, item) => acc + (item.price * item.quantity), 0);
            const orderData = { 
                items: cart, 
                total: total,
                date: new Date().toLocaleDateString('es-CL')
            };
            localStorage.setItem('pendingOrder', JSON.stringify(orderData));
            console.log("✅ Datos guardados en localStorage:", orderData);

            const btn = this;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-sync fa-spin"></i> Guardando...';

            try {
                // ✅ PASO 2: Limpiar carrito en backend ANTES de crear pedido
                await fetch(`${API_URL}/carrito`, { 
                    method: 'DELETE', 
                    headers: getAuthHeaders() 
                }).catch(() => {
                    console.warn("⚠️ No se pudo limpiar carrito en backend");
                });

                // ✅ PASO 3: Agregar items al carrito en backend (para que el pedido se cree con datos)
                for (const item of cart) {
                    await fetch(`${API_URL}/carrito/items`, {
                        method: 'POST',
                        headers: getAuthHeaders(),
                        body: JSON.stringify({ 
                            producto_id: item.id, 
                            cantidad: item.quantity 
                        })
                    }).catch(err => console.warn("⚠️ Error agregando item:", err));
                }

                console.log("✅ Carrito sincronizado con backend");

                // ✅ PASO 4: Ir a ConfirmacionPedido.html
                setTimeout(() => {
                    window.location.href = 'ConfirmacionPedido.html';
                }, 500);

            } catch (error) {
                console.error("❌ Error:", error);
                alert("Error de conexión");
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-check me-2"></i>Confirmar Pedido';
            }
        };

        document.getElementById('clearCartBtn').onclick = () => {
            if(confirm("¿Vaciar carrito?")) { localStorage.removeItem('chocomaniaCart'); renderCart(); }
        };
        document.getElementById('continueShoppingBtn').onclick = () => window.location.href = "Catalogo.html";
        document.getElementById('continueShoppingBtn2').onclick = () => window.location.href = "Catalogo.html";

        // INICIALIZAR
        loadUserData(); // <-- ESTO CARGA TU NOMBRE
        renderCart();
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>